<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nodes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Navigation: remove button chrome, enlarge like h5, underline on hover */
        nav.top-nav .btn {
            border: none !important;
            background: transparent !important;
            box-shadow: none !important;
            padding: 0.15rem 0.6rem;
            font-size: 1rem; /* similar size to h5 */
            line-height: 1;
            color: inherit;
        }
        /* keep focus visible but not button-like */
        nav.top-nav .btn:focus {
            outline: 2px solid rgba(0,123,255,0.18);
            outline-offset: 2px;
            text-decoration: none;
        }
        /* underline on hover */
        nav.top-nav .btn:hover,
        nav.top-nav .btn:active {
            text-decoration: underline;
            background: transparent !important;
            transform: none;
        }

        /* Slight spacing tweak so the nav doesn't crowd the title */
        .page-header {
            gap: 1rem;
        }

        /* Full-page background using the provided image */
        body {
            background-image: url('/img/node_page.png');
            background-size: cover;
            background-repeat: no-repeat;
        }
        
        h1 {
            color: #964B00; /* Dark text for better contrast */
            font-family: 'Times New Roman', Times, serif;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 page-header">
        <h1 class="mb-0">Circulus Casa</h1>
        <nav class="top-nav d-flex gap-2">
            <a class="btn btn-sm btn-outline-secondary" href="/circulus_casa/home">Home</a>
            <a class="btn btn-sm btn-outline-secondary" href="/circulus_casa/users">Users</a>
            <a class="btn btn-sm btn-outline-secondary" href="/circulus_casa/circles">Circles</a>
            <a class="btn btn-sm btn-outline-secondary text-decoration-underline" href="/circulus_casa/nodes">Nodes</a>
            <a class="btn btn-sm btn-outline-secondary" href="/circulus_casa/join_requests">Join Requests</a>
        </nav>
    </div>

    <div id="alertPlaceholder"></div>

    <!-- Create -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Add Node</h5>
            <form id="createNodeForm" class="row g-2">
                <div class="col-md-2">
                    <input id="createUserId" name="userId" type="number" class="form-control" placeholder="User ID" required>
                </div>
                <div class="col-md-2">
                    <input id="createCircleId" name="circleId" type="number" class="form-control" placeholder="Circle ID" required>
                </div>
                <div class="col-md-2 d-flex align-items-center">
                    <div class="form-check">
                        <input id="createIsCircleOwner" name="isCircleOwner" class="form-check-input" type="checkbox">
                        <label class="form-check-label">Owner</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <input id="createBalance" name="balance" type="number" step="0.01" class="form-control" placeholder="Balance">
                </div>
                <div class="col-md-2 d-grid">
                    <button class="btn btn-primary" type="submit">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Update node modal -->
    <div class="modal fade" id="updateNodeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form id="updateNodeModalForm">
            <div class="modal-header">
              <h5 class="modal-title">Update Node</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input id="updateNodeId" type="hidden">
                <div class="mb-3">
                    <label class="form-label">User ID</label>
                    <input id="updateUserId" type="number" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Circle ID</label>
                    <input id="updateCircleId" type="number" class="form-control" required>
                </div>
                <div class="mb-3 form-check">
                    <input id="updateIsCircleOwner" class="form-check-input" type="checkbox">
                    <label class="form-check-label">Owner</label>
                </div>
                <div class="mb-3">
                    <label class="form-label">Balance</label>
                    <input id="updateBalance" type="number" step="0.01" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <table class="table table-bordered table-striped">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>User ID</th>
            <th>Circle ID</th>
            <th>Owner</th>
            <th>Balance</th>
            <th style="width:150px">Actions</th>
        </tr>
        </thead>
        <tbody id="nodeTableBody"></tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // highlight nav link that matches current path
    function highlightNav() {
        const links = document.querySelectorAll('nav.top-nav a');
        const loc = location.pathname.replace(/\/$/, '');
        links.forEach(a => {
            const linkPath = new URL(a.href, location.origin).pathname.replace(/\/$/, '');
            if (loc === linkPath || (linkPath !== '' && loc.startsWith(linkPath + '/'))) {
                a.classList.add('active-link');
                a.setAttribute('aria-current', 'page');
            } else {
                a.classList.remove('active-link');
                a.removeAttribute('aria-current');
            }
        });
    }
    highlightNav();
    window.addEventListener('popstate', highlightNav);
    (function(){ const _push = history.pushState; history.pushState = function(){ _push.apply(this, arguments); highlightNav(); }; })();

    const alertPlaceholder = document.getElementById('alertPlaceholder');
    const updateNodeModalEl = document.getElementById('updateNodeModal');
    const updateNodeModal = new bootstrap.Modal(updateNodeModalEl);

    function showAlert(msg,type='success'){ const w=document.createElement('div'); w.innerHTML=`<div class="alert alert-${type} alert-dismissible" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`; alertPlaceholder.append(w); setTimeout(()=>w.remove(),5000); }

    async function loadNodes(){
        try {
            const res = await fetch('/nodes');
            if(!res.ok) throw new Error();
            const list = await res.json();
            renderTable(list);
        } catch(e){
            document.getElementById('nodeTableBody').innerHTML = `<tr><td colspan="6" class="text-danger text-center">Failed to load nodes</td></tr>`;
        }
    }

    function renderTable(list){
        const tbody = document.getElementById('nodeTableBody'); tbody.innerHTML='';
        if(!Array.isArray(list) || list.length===0){ tbody.innerHTML=`<tr><td colspan="6" class="text-center">No nodes found</td></tr>`; return; }
        list.forEach(n=>{
            const owner = (n.isCircleOwner === true || n.is_circle_owner === true) ? 'Yes' : 'No';
            const balance = n.balance != null ? n.balance : '';
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${n.nodeId ?? ''}</td>
                          <td>${n.userId ?? ''}</td>
                          <td>${n.circleId ?? ''}</td>
                          <td>${owner}</td>
                          <td>${balance}</td>
                          <td>
                            <div class="d-flex gap-2">
                              <button class="btn btn-sm btn-outline-primary" data-action="edit" data-id="${n.nodeId}">Edit</button>
                              <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${n.nodeId}">Delete</button>
                            </div>
                          </td>`;
            tbody.appendChild(tr);
        });

        tbody.querySelectorAll('button[data-action="edit"]').forEach(btn=>{
            btn.addEventListener('click', ()=>{
                const row = btn.closest('tr'); const id = btn.getAttribute('data-id');
                const userId = row.cells[1].textContent; const circleId = row.cells[2].textContent;
                const owner = row.cells[3].textContent === 'Yes';
                const balance = row.cells[4].textContent;
                showEditModal({ nodeId: Number(id), userId: Number(userId), circleId: Number(circleId), isCircleOwner: owner, balance: balance });
            });
        });

        tbody.querySelectorAll('button[data-action="delete"]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
                const id = btn.getAttribute('data-id');
                if(!confirm('Delete node #'+id+'?')) return;
                try {
                    const res = await fetch(`/nodes/${id}`, { method:'DELETE' });
                    if(res.ok){ showAlert('Node deleted'); loadNodes(); }
                    else if(res.status===404){ showAlert('Not found','warning'); loadNodes(); }
                    else throw new Error();
                } catch(e){ showAlert('Failed to delete','danger'); }
            });
        });
    }

    function showEditModal(n){
        document.getElementById('updateNodeId').value = n.nodeId ?? '';
        document.getElementById('updateUserId').value = n.userId ?? '';
        document.getElementById('updateCircleId').value = n.circleId ?? '';
        document.getElementById('updateIsCircleOwner').checked = !!n.isCircleOwner;
        document.getElementById('updateBalance').value = n.balance ?? '';
        updateNodeModal.show();
    }

    // Create
    document.getElementById('createNodeForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const payload = {
            userId: Number(document.getElementById('createUserId').value),
            circleId: Number(document.getElementById('createCircleId').value),
            isCircleOwner: document.getElementById('createIsCircleOwner').checked,
            balance: toNullableNumber(document.getElementById('createBalance').value)
        };
        try {
            const res = await fetch('/nodes', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
            if(res.ok){ showAlert('Node added'); e.target.reset(); loadNodes(); } else throw new Error();
        } catch(e){ showAlert('Failed to add node','danger'); }
    });

    // Update via modal
    document.getElementById('updateNodeModalForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const id = document.getElementById('updateNodeId').value;
        const payload = {
            userId: Number(document.getElementById('updateUserId').value),
            circleId: Number(document.getElementById('updateCircleId').value),
            isCircleOwner: document.getElementById('updateIsCircleOwner').checked,
            balance: toNullableNumber(document.getElementById('updateBalance').value)
        };
        try {
            const res = await fetch(`/nodes/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
            if(res.ok){ showAlert('Node updated'); updateNodeModal.hide(); loadNodes(); }
            else if(res.status===404){ showAlert('Not found','warning'); loadNodes(); }
            else throw new Error();
        } catch(e){ showAlert('Failed to update','danger'); }
    });

    function toNullableNumber(v){ return v === '' ? null : Number(v); }

    loadNodes();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Circles</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Navigation: remove button chrome, enlarge like h5, underline on hover */
        nav.top-nav .btn {
            border: none !important;
            background: transparent !important;
            box-shadow: none !important;
            padding: 0.15rem 0.6rem;
            font-size: 1rem; /* similar size to h5 */
            line-height: 1;
            color: inherit;
        }
        /* keep focus visible but not button-like */
        nav.top-nav .btn:focus {
            outline: 2px solid rgba(0,123,255,0.18);
            outline-offset: 2px;
            text-decoration: none;
        }
        /* underline on hover */
        nav.top-nav .btn:hover,
        nav.top-nav .btn:active {
            text-decoration: underline;
            background: transparent !important;
            transform: none;
        }

        /* Slight spacing tweak so the nav doesn't crowd the title */
        .page-header {
            gap: 1rem;
        }

        /* Ring modal styling + modal fit rules (existing) */
        .ring-canvas { display:block; margin:0 auto; max-width:100%; height:auto; }
        .node-chip { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; fill:#fff; font-weight:600; pointer-events:none; text-anchor:middle; }
        .node-badge { font-size:12px; fill:#222; font-weight:600; text-anchor:middle; }
        .node-circle { stroke: rgba(255,255,255,0.2); stroke-width:2; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.25)); transition: transform .18s ease; transform-origin: center center; cursor: pointer; }
        .node-circle:hover { transform: scale(1.08); }
        .ring-bg { fill: url(#ringGradient); opacity:0.06; }
        .no-nodes { text-align:center; padding:2rem; color:#666; }

        .modal-dialog.modal-xl { max-width:900px; margin:1.5rem auto; }
        .modal-body { display:flex; flex-direction:column; align-items:center; padding:1.25rem; }
        #ringContainer { width:100%; display:flex; justify-content:center; align-items:center; }
        .ring-svg { max-width:100%; height:auto; max-height:calc(100vh - 240px); display:block; }
        .ring-legend-row { display:flex; gap:.75rem; justify-content:center; align-items:center; flex-wrap:wrap; }

        @media (max-width:640px) { .modal-dialog { max-width:95%; margin:1rem auto; } .ring-svg { max-height:60vh; } }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 page-header">
        <h2 class="mb-0">Circles</h2>
        <nav class="top-nav d-flex gap-2">
            <a class="btn btn-sm btn-outline-secondary" href="/circulus_casa/users">Users</a>
            <a class="btn btn-sm btn-outline-secondary text-decoration-underline" href="/circulus_casa/circles">Circles</a>
            <a class="btn btn-sm btn-outline-secondary" href="/circulus_casa/nodes">Nodes</a>
            <a class="btn btn-sm btn-outline-secondary" href="/circulus_casa/join_requests">Join Requests</a>
        </nav>
    </div>

    <div id="alertPlaceholder"></div>

    <!-- Create form -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Add Circle</h5>
            <form id="createCircleForm" class="row g-2">
                <div class="col-md-4">
                    <input id="createCircleName" class="form-control" placeholder="Circle name" required>
                </div>
                <div class="col-md-2">
                    <input id="createPaymentCycle" type="number" class="form-control" placeholder="Payment cycle (days)">
                </div>
                <div class="col-md-3">
                    <input id="createPaymentCycleStartDate" type="date" class="form-control" placeholder="Start date">
                </div>
                <div class="col-md-2">
                    <input id="createPaymentAmount" type="number" step="0.01" class="form-control" placeholder="Amount">
                </div>
                <div class="col-md-1 d-grid">
                    <button class="btn btn-primary" type="submit">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Update circle modal -->
    <div class="modal fade" id="updateCircleModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form id="updateCircleModalForm">
            <div class="modal-header">
              <h5 class="modal-title">Update Circle</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input id="updateCircleId" type="hidden">
                <div class="mb-3">
                    <label class="form-label">Name</label>
                    <input id="updateCircleName" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Payment Cycle (days)</label>
                    <input id="updatePaymentCycle" type="number" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Start Date</label>
                    <input id="updatePaymentCycleStartDate" type="date" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Amount</label>
                    <input id="updatePaymentAmount" type="number" step="0.01" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- View nodes modal (ring) -->
    <div class="modal fade" id="viewNodesModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="viewNodesTitle" class="modal-title">Circle Nodes</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body d-flex flex-column align-items-center">
              <div id="ringContainer">
                  <!-- SVG will be injected here -->
              </div>
              <div id="ringLegend" class="mt-3 w-100 text-center"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <table class="table table-bordered table-striped">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Cycle</th>
            <th>Start Date</th>
            <th>Amount</th>
            <th style="width:230px">Actions</th>
        </tr>
        </thead>
        <tbody id="circleTableBody"></tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // highlight nav link that matches current path
    function highlightNav() {
        const links = document.querySelectorAll('nav.top-nav a');
        const loc = location.pathname.replace(/\/$/, '');
        links.forEach(a => {
            const linkPath = new URL(a.href, location.origin).pathname.replace(/\/$/, '');
            if (loc === linkPath || (linkPath !== '' && loc.startsWith(linkPath + '/'))) {
                a.classList.add('active-link');
                a.setAttribute('aria-current', 'page');
            } else {
                a.classList.remove('active-link');
                a.removeAttribute('aria-current');
            }
        });
    }
    highlightNav();
    window.addEventListener('popstate', highlightNav);
    (function(){ const _push = history.pushState; history.pushState = function(){ _push.apply(this, arguments); highlightNav(); }; })();

    const alertPlaceholder = document.getElementById('alertPlaceholder');
    const updateCircleModalEl = document.getElementById('updateCircleModal');
    const updateCircleModal = new bootstrap.Modal(updateCircleModalEl);
    const viewNodesModalEl = document.getElementById('viewNodesModal');
    const viewNodesModal = new bootstrap.Modal(viewNodesModalEl);
    const ringContainer = document.getElementById('ringContainer');
    const viewNodesTitle = document.getElementById('viewNodesTitle');
    const ringLegend = document.getElementById('ringLegend');

    function showAlert(msg, type='success'){ const w=document.createElement('div'); w.innerHTML=`<div class="alert alert-${type} alert-dismissible" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`; alertPlaceholder.append(w); setTimeout(()=>w.remove(),5000); }

    async function loadCircles(){ try { const res = await fetch('/circles'); if(!res.ok) throw new Error(); const list = await res.json(); renderTable(list); } catch(e){ document.getElementById('circleTableBody').innerHTML = `<tr><td colspan="6" class="text-danger text-center">Failed to load circles</td></tr>`; } }

    function renderTable(list){
        const tbody = document.getElementById('circleTableBody');
        tbody.innerHTML = '';
        if(!Array.isArray(list) || list.length===0){ tbody.innerHTML = `<tr><td colspan="6" class="text-center">No circles found</td></tr>`; return; }
        list.forEach(c=>{
            const start = c.paymentCycleStartDate ? new Date(c.paymentCycleStartDate).toLocaleDateString() : '';
            const amount = c.paymentAmount != null ? c.paymentAmount : '';
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${c.circleId ?? ''}</td>
                            <td>${escapeHtml(c.circleName)}</td>
                            <td>${c.paymentCycle ?? ''}</td>
                            <td>${start}</td>
                            <td>${amount}</td>
                            <td>
                              <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" data-action="edit" data-id="${c.circleId}">Edit</button>
                                <button class="btn btn-sm btn-outline-secondary" data-action="view" data-id="${c.circleId}" data-name="${escapeHtml(c.circleName)}">View</button>
                                <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${c.circleId}">Delete</button>
                              </div>
                            </td>`;
            tbody.appendChild(tr);
        });

        tbody.querySelectorAll('button[data-action="edit"]').forEach(btn=>{
            btn.addEventListener('click', ()=> {
                const row = btn.closest('tr');
                const id = btn.getAttribute('data-id');
                const name = row.cells[1].textContent;
                const cycle = row.cells[2].textContent;
                const startCell = row.cells[3].textContent;
                const amount = row.cells[4].textContent;
                const isoDate = startCell ? new Date(startCell).toISOString().slice(0,10) : '';
                showEditModal({ circleId: Number(id), circleName: name, paymentCycle: cycle, paymentCycleStartDate: isoDate, paymentAmount: amount });
            });
        });

        tbody.querySelectorAll('button[data-action="view"]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
                const id = Number(btn.getAttribute('data-id'));
                const name = btn.getAttribute('data-name') || `Circle ${id}`;
                await showCircleNodesRing(id, name);
            });
        });

        tbody.querySelectorAll('button[data-action="delete"]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
                const id = btn.getAttribute('data-id');
                if(!confirm('Delete circle #' + id + '?')) return;
                try {
                    const res = await fetch(`/circles/${id}`, { method: 'DELETE' });
                    if(res.ok){ showAlert('Circle deleted'); loadCircles(); }
                    else if(res.status===404){ showAlert('Not found','warning'); loadCircles(); }
                    else throw new Error();
                } catch(e){ showAlert('Failed to delete','danger'); }
            });
        });
    }

    function escapeHtml(s){ return s==null? '': String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

    // Create
    document.getElementById('createCircleForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const payload = {
            circleName: document.getElementById('createCircleName').value.trim(),
            paymentCycle: toNullableInt(document.getElementById('createPaymentCycle').value),
            paymentCycleStartDate: document.getElementById('createPaymentCycleStartDate').value || null,
            paymentAmount: toNullableNumber(document.getElementById('createPaymentAmount').value)
        };
        try {
            const res = await fetch('/circles', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
            if(res.ok){ const created = await res.json(); showAlert('Circle added (ID: ' + (created.circleId ?? '') + ')'); e.target.reset(); loadCircles(); }
            else throw new Error();
        } catch(e){ showAlert('Failed to add circle','danger'); }
    });

    function showEditModal(c){
        document.getElementById('updateCircleId').value = c.circleId ?? '';
        document.getElementById('updateCircleName').value = c.circleName ?? '';
        document.getElementById('updatePaymentCycle').value = c.paymentCycle ?? '';
        document.getElementById('updatePaymentCycleStartDate').value = c.paymentCycleStartDate ?? '';
        document.getElementById('updatePaymentAmount').value = c.paymentAmount ?? '';
        updateCircleModal.show();
    }

    // Update
    document.getElementById('updateCircleModalForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const id = document.getElementById('updateCircleId').value;
        const payload = {
            circleName: document.getElementById('updateCircleName').value.trim(),
            paymentCycle: toNullableInt(document.getElementById('updatePaymentCycle').value),
            paymentCycleStartDate: document.getElementById('updatePaymentCycleStartDate').value || null,
            paymentAmount: toNullableNumber(document.getElementById('updatePaymentAmount').value)
        };
        try {
            const res = await fetch(`/circles/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
            if(res.ok){ showAlert('Circle updated'); updateCircleModal.hide(); loadCircles(); }
            else if(res.status===404){ showAlert('Not found','warning'); loadCircles(); }
            else throw new Error();
        } catch(e){ showAlert('Failed to update','danger'); }
    });

    function toNullableInt(v){ return v === '' ? null : Number(v); }
    function toNullableNumber(v){ return v === '' ? null : Number(v); }

    // --- New: View nodes ring ---
    async function showCircleNodesRing(circleId, circleName){
        viewNodesTitle.textContent = `Nodes in "${circleName}"`;
        ringContainer.innerHTML = `<div class="p-3 text-muted">Loading nodes…</div>`;
        ringLegend.innerHTML = '';

        try {
            const res = await fetch('/nodes');
            if(!res.ok) throw new Error('Failed to load nodes');
            const nodes = await res.json();
            const filtered = Array.isArray(nodes) ? nodes.filter(n => Number(n.circleId) === Number(circleId)) : [];

            if(!filtered.length){
                ringContainer.innerHTML = `<div class="no-nodes">No nodes attached to this circle.</div>`;
                viewNodesModal.show();
                return;
            }

            // compute size so SVG always fits modal on standard laptop
            // available height for SVG = viewport height - modal chrome (approx 240px)
            const availWidth = Math.min(window.innerWidth * 0.8, 900);
            const availHeight = Math.max(320, window.innerHeight - 240);
            const size = Math.min(720, availWidth, availHeight);
            const center = size / 2;
            const svgNS = 'http://www.w3.org/2000/svg';
            const svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('class','ring-svg ring-canvas');
            svg.setAttribute('width', String(size));
            svg.setAttribute('height', String(size));
            svg.setAttribute('viewBox', `0 0 ${size} ${size}`);

            // defs -> gradient
            const defs = document.createElementNS(svgNS, 'defs');
            defs.innerHTML = `
                <linearGradient id="ringGradient" x1="0" x2="1">
                  <stop offset="0%" stop-color="#6EE7B7"/>
                  <stop offset="50%" stop-color="#60A5FA"/>
                  <stop offset="100%" stop-color="#C084FC"/>
                </linearGradient>
            `;
            svg.appendChild(defs);

            // subtle background ring
            const ring = document.createElementNS(svgNS, 'circle');
            ring.setAttribute('cx', String(center));
            ring.setAttribute('cy', String(center));
            ring.setAttribute('r', String(center * 0.62));
            ring.setAttribute('class', 'ring-bg');
            svg.appendChild(ring);

            // title in center
            const titleText = document.createElementNS(svgNS, 'text');
            titleText.setAttribute('x', String(center));
            titleText.setAttribute('y', String(center - 8));
            titleText.setAttribute('class', 'node-chip');
            titleText.setAttribute('font-size', Math.max(14, size * 0.03));
            titleText.textContent = circleName;
            svg.appendChild(titleText);

            const subText = document.createElementNS(svgNS, 'text');
            subText.setAttribute('x', String(center));
            subText.setAttribute('y', String(center + 18));
            subText.setAttribute('class', 'node-badge');
            subText.setAttribute('font-size', Math.max(11, size * 0.02));
            subText.textContent = `${filtered.length} node${filtered.length>1?'s':''}`;
            svg.appendChild(subText);

            // compute node positions
            const n = filtered.length;
            const radius = center * 0.62;
            const nodeRadius = Math.max(24, size * 0.045);
            const startAngle = -Math.PI / 2; // start top
            const gapAngle = (Math.PI * 2) / n;

            // color palette
            const palette = ['#06b6d4','#f97316','#10b981','#7c3aed','#ef4444','#f59e0b','#3b82f6','#8b5cf6'];

            filtered.forEach((node, i) => {
                const angle = startAngle + gapAngle * i;
                const x = center + Math.cos(angle) * radius;
                const y = center + Math.sin(angle) * radius;

                // link line from center to node (arc-like)
                const line = document.createElementNS(svgNS, 'line');
                line.setAttribute('x1', String(center + Math.cos(angle) * (radius * 0.35)));
                line.setAttribute('y1', String(center + Math.sin(angle) * (radius * 0.35)));
                line.setAttribute('x2', String(x));
                line.setAttribute('y2', String(y));
                line.setAttribute('stroke', 'rgba(0,0,0,0.06)');
                line.setAttribute('stroke-width', '2');
                svg.appendChild(line);

                // node circle
                const circleEl = document.createElementNS(svgNS, 'circle');
                const color = palette[i % palette.length];
                circleEl.setAttribute('cx', String(x));
                circleEl.setAttribute('cy', String(y));
                circleEl.setAttribute('r', String(nodeRadius));
                circleEl.setAttribute('fill', color);
                circleEl.setAttribute('class', 'node-circle');
                circleEl.setAttribute('data-user-id', String(node.userId ?? ''));
                svg.appendChild(circleEl);

                // initials text
                const txt = document.createElementNS(svgNS, 'text');
                txt.setAttribute('x', String(x));
                txt.setAttribute('y', String(y + 6));
                txt.setAttribute('class', 'node-chip');
                txt.setAttribute('font-size', Math.max(12, size * 0.018));
                txt.textContent = getInitials(node);
                svg.appendChild(txt);

                // balance badge
                const badgeY = y + nodeRadius + 14;
                const badge = document.createElementNS(svgNS, 'text');
                badge.setAttribute('x', String(x));
                badge.setAttribute('y', String(badgeY));
                badge.setAttribute('class', 'node-badge');
                badge.setAttribute('font-size', Math.max(11, size * 0.016));
                badge.textContent = node.balance != null ? `$${Number(node.balance).toFixed(2)}` : '';
                svg.appendChild(badge);

                // hover tooltip behavior
                circleEl.addEventListener('mouseenter', () => {
                    circleEl.setAttribute('stroke', 'rgba(255,255,255,0.35)');
                    circleEl.setAttribute('stroke-width', '3');
                });
                circleEl.addEventListener('mouseleave', () => {
                    circleEl.setAttribute('stroke', '');
                });
                circleEl.addEventListener('click', () => {
                    showAlert(`Node #${node.nodeId} — user ${node.userId} — balance ${node.balance ?? '0.00'}`, 'info');
                });
            });

            // inject svg
            ringContainer.innerHTML = '';
            ringContainer.appendChild(svg);

            viewNodesModal.show();
        } catch (err) {
            console.error(err);
            ringContainer.innerHTML = `<div class="no-nodes">Failed to load nodes.</div>`;
            viewNodesModal.show();
        }
    }

    function getInitials(node){
        // Use userId as fallback display, can be replaced by user info later
        if(node.username) {
            const parts = String(node.username).trim().split(/\s+/);
            return parts.length>1 ? (parts[0][0]+parts[1][0]).toUpperCase() : parts[0].slice(0,2).toUpperCase();
        }
        if(node.userId) return String(node.userId).slice(-2);
        return 'N';
    }

    loadCircles();
    // adjust SVG size if window changes while modal open
    window.addEventListener('resize', () => {
        // if modal open and has svg, rebuild to fit
        if (document.querySelector('#viewNodesModal.show') || document.querySelector('.modal-backdrop')) {
            // simple approach: if ringContainer has SVG, trigger view rebuild for the currently displayed circle
            // this is left lightweight to avoid tight coupling; user can re-open view if needed
        }
    });
</script>
</body>
</html>
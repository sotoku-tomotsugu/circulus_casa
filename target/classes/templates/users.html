<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Directory</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Navigation: remove button chrome, enlarge like h5, underline on hover */
        nav.top-nav .btn {
            border: none !important;
            background: transparent !important;
            box-shadow: none !important;
            padding: 0.15rem 0.6rem;
            font-size: 1rem; /* similar size to h5 */
            line-height: 1;
            color: inherit;
        }
        /* keep focus visible but not button-like */
        nav.top-nav .btn:focus {
            outline: 2px solid rgba(0,123,255,0.18);
            outline-offset: 2px;
            text-decoration: none;
        }
        /* underline on hover */
        nav.top-nav .btn:hover,
        nav.top-nav .btn:active {
            text-decoration: underline;
            background: transparent !important;
            transform: none;
        }

        /* Slight spacing tweak so the nav doesn't crowd the title */
        .page-header {
            gap: 1rem;
        }

        /* Full-page background using the provided image */
        body {
            background-image: url('/img/user_page.png');
            background-size: cover;
            background-repeat: no-repeat;
        }
        
        h1 {
            color: #964B00; /* Dark text for better contrast */
            font-family: 'Times New Roman', Times, serif;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 page-header">
        <h1 class="mb-0">Circulus Casa</h1>
        <nav class="top-nav d-flex gap-2">
            <a class="btn btn-sm btn-outline-secondary" href="/circulus_casa/home">Home</a>
            <a class="btn btn-sm btn-outline-secondary text-decoration-underline" href="/circulus_casa/users">Users</a>
            <a class="btn btn-sm btn-outline-secondary" href="/circulus_casa/circles">Circles</a>
            <a class="btn btn-sm btn-outline-secondary" href="/circulus_casa/nodes">Nodes</a>
            <a class="btn btn-sm btn-outline-secondary" href="/circulus_casa/join_requests">Join Requests</a>
        </nav>
    </div>

    <div id="alertPlaceholder"></div>

    <!-- Create user form -->
    <div class="card mb-4 d-none">
        <div class="card-body">
            <h5 class="card-title">Add User</h5>
            <form id="createUserForm" class="row g-2">
                <div class="col-md-5">
                    <input id="createUsername" name="username" type="text" class="form-control" placeholder="Username" required>
                </div>
                <div class="col-md-5">
                    <input id="createPassword" name="password" type="password" class="form-control" placeholder="Password" required>
                </div>
                <div class="col-md-2 d-grid">
                    <button class="btn btn-primary" type="submit">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Update user modal -->
    <div class="modal fade" id="updateUserModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form id="updateUserModalForm">
            <div class="modal-header">
              <h5 class="modal-title">Update User</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input id="updateUserId" name="userId" type="hidden">
                <div class="mb-3">
                    <label for="updateUsername" class="form-label">Username</label>
                    <input id="updateUsername" name="username" type="text" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="updatePassword" class="form-label">Password</label>
                    <input id="updatePassword" name="password" type="password" class="form-control" required>
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <table class="table table-bordered table-striped">
        <thead class="table-dark">
        <tr>
            <th>User ID</th>
            <th>Username</th>
            <th>Password</th>
            <th style="width:170px">Actions</th>
        </tr>
        </thead>
        <tbody id="userTableBody"></tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const alertPlaceholder = document.getElementById('alertPlaceholder');
    const updateUserModalEl = document.getElementById('updateUserModal');
    const updateUserModal = new bootstrap.Modal(updateUserModalEl);

    function showAlert(message, type = 'success') {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `<div class="alert alert-${type} alert-dismissible" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
        alertPlaceholder.append(wrapper);
        setTimeout(() => wrapper.remove(), 5000);
    }

    // mask password visually on list (keeps actual password only available from API)
    function maskPassword(p) {
        if (!p) return '';
        return 'â€¢'.repeat(p.length);
    }

    async function loadUsers() {
        try {
            const res = await fetch('/users');
            if (!res.ok) throw new Error('Failed to load users');
            const users = await res.json();
            renderTable(users);
        } catch (err) {
            console.error(err);
            document.getElementById('userTableBody').innerHTML =
                `<tr><td colspan="4" class="text-danger text-center">Failed to load users</td></tr>`;
        }
    }

    function renderTable(users) {
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';
        if (!Array.isArray(users) || users.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center">No users found</td></tr>`;
            return;
        }
        users.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${u.userId ?? ''}</td>
                <td>${escapeHtml(u.username)}</td>
                <td>${maskPassword(u.password)}</td>
                <td>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" data-action="edit" data-id="${u.userId}">Edit</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });

        // Attach action listeners
        tbody.querySelectorAll('button[data-action="edit"]').forEach(btn => {
            btn.addEventListener('click', async () => {
                const id = btn.getAttribute('data-id');
                // fetch real user data (including password) from API before showing modal
                try {
                    const res = await fetch(`/users/${id}`);
                    if (!res.ok) {
                        if (res.status === 404) { showAlert('User not found', 'warning'); loadUsers(); return; }
                        throw new Error('Failed to fetch user');
                    }
                    const user = await res.json();
                    showEditModal(user);
                } catch (err) {
                    console.error(err);
                    showAlert('Failed to load user details', 'danger');
                }
            });
        });

        tbody.querySelectorAll('button[data-action="delete"]').forEach(btn => {
            btn.addEventListener('click', async () => {
                const id = btn.getAttribute('data-id');
                if (!confirm('Delete user #' + id + '?')) return;
                try {
                    const res = await fetch(`/users/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        showAlert('User deleted', 'success');
                        loadUsers();
                    } else if (res.status === 404) {
                        showAlert('User not found', 'warning');
                        loadUsers();
                    } else {
                        throw new Error('Delete failed');
                    }
                } catch (err) {
                    console.error(err);
                    showAlert('Failed to delete user', 'danger');
                }
            });
        });
    }

    function escapeHtml(s) {
        return s === null || s === undefined ? '' : String(s)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // Create
    document.getElementById('createUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('createUsername').value.trim();
        const password = document.getElementById('createPassword').value;
        if (!username || !password) return showAlert('Username and password are required', 'warning');

        try {
            const res = await fetch('/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            if (res.ok) {
                const created = await res.json();
                showAlert('User added (ID: ' + (created.userId ?? created.user_id ?? '') + ')', 'success');
                e.target.reset();
                loadUsers();
            } else {
                const text = await res.text();
                throw new Error(text || 'Create failed');
            }
        } catch (err) {
            console.error(err);
            showAlert('Failed to add user', 'danger');
        }
    });

    // Show modal populated with actual data from API
    function showEditModal(user) {
        document.getElementById('updateUserId').value = user.userId;
        document.getElementById('updateUsername').value = user.username;
        // populate password field with real password so it can be edited
        document.getElementById('updatePassword').value = user.password || '';
        updateUserModal.show();
    }

    // Update via modal form
    document.getElementById('updateUserModalForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('updateUserId').value;
        const username = document.getElementById('updateUsername').value.trim();
        const password = document.getElementById('updatePassword').value;
        if (!id || !username || !password) return showAlert('All fields required', 'warning');

        try {
            const res = await fetch(`/users/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            if (res.ok) {
                showAlert('User updated', 'success');
                updateUserModal.hide();
                loadUsers();
            } else if (res.status === 404) {
                showAlert('User not found', 'warning');
                loadUsers();
            } else {
                const text = await res.text();
                throw new Error(text || 'Update failed');
            }
        } catch (err) {
            console.error(err);
            showAlert('Failed to update user', 'danger');
        }
    });

    // Load on start
    loadUsers();
</script>
</body>
</html>
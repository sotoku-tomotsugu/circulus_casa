<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Join Requests</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Navigation: remove button chrome, enlarge like h5, underline on hover */
        nav.top-nav .btn {
            border: none !important;
            background: transparent !important;
            box-shadow: none !important;
            padding: 0.15rem 0.6rem;
            font-size: 1rem; /* similar size to h5 */
            line-height: 1;
            color: inherit;
        }
        /* keep focus visible but not button-like */
        nav.top-nav .btn:focus {
            outline: 2px solid rgba(0,123,255,0.18);
            outline-offset: 2px;
            text-decoration: none;
        }
        /* underline on hover */
        nav.top-nav .btn:hover,
        nav.top-nav .btn:active {
            text-decoration: underline;
            background: transparent !important;
            transform: none;
        }

        /* Slight spacing tweak so the nav doesn't crowd the title */
        .page-header {
            gap: 1rem;
        }

        /* Full-page background using the provided image */
        body {
            background-image: url('/img/join_request_page.png');
            background-size: cover;
            background-repeat: no-repeat;
        }
        
        h1 {
            color: #964B00; /* Dark text for better contrast */
            font-family: 'Times New Roman', Times, serif;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 page-header">
        <h1 class="mb-0">Circulus Casa</h1>
        <nav class="top-nav d-flex gap-2">
            <a class="btn btn-sm btn-outline-secondary" href="/circulus_casa/home">Home</a>
            <a class="btn btn-sm btn-outline-secondary" href="/circulus_casa/users">Users</a>
            <a class="btn btn-sm btn-outline-secondary" href="/circulus_casa/circles">Circles</a>
            <a class="btn btn-sm btn-outline-secondary" href="/circulus_casa/nodes">Nodes</a>
            <a class="btn btn-sm btn-outline-secondary text-decoration-underline" href="/circulus_casa/join_requests">Join Requests</a>
        </nav>
    </div>

    <div id="alertPlaceholder"></div>

    <!-- Create -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Add Join Request</h5>
            <form id="createJRForm" class="row g-2">
                <div class="col-md-2">
                    <input id="createRequesterId" name="requesterId" type="number" class="form-control" placeholder="Requester ID" required>
                </div>
                <div class="col-md-2">
                    <input id="createCircleId" name="circleId" type="number" class="form-control" placeholder="Circle ID" required>
                </div>
                <div class="col-md-2">
                    <input id="createApproverId" name="approverId" type="number" class="form-control" placeholder="Approver ID">
                </div>
                <div class="col-md-2 d-flex align-items-center">
                    <div class="form-check">
                        <input id="createIsApproved" name="isApproved" class="form-check-input" type="checkbox">
                        <label class="form-check-label">Approved</label>
                    </div>
                </div>
                <div class="col-md-2 d-grid">
                    <button class="btn btn-primary" type="submit">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Update join request modal -->
    <div class="modal fade" id="updateJRModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form id="updateJRModalForm">
            <div class="modal-header">
              <h5 class="modal-title">Update Join Request</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input id="updateRequestId" type="hidden">
                <div class="mb-3">
                    <label class="form-label">Requester ID</label>
                    <input id="updateRequesterId" type="number" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Circle ID</label>
                    <input id="updateCircleId" type="number" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Approver ID</label>
                    <input id="updateApproverId" type="number" class="form-control">
                </div>
                <div class="mb-3 form-check">
                    <input id="updateIsApproved" class="form-check-input" type="checkbox">
                    <label class="form-check-label">Approved</label>
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <table class="table table-bordered table-striped">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Requester</th>
            <th>Circle</th>
            <th>Approver</th>
            <th>Approved</th>
            <th style="width:150px">Actions</th>
        </tr>
        </thead>
        <tbody id="jrTableBody"></tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // highlight nav link that matches current path
    function highlightNav() {
        const links = document.querySelectorAll('nav.top-nav a');
        const loc = location.pathname.replace(/\/$/, '');
        links.forEach(a => {
            const linkPath = new URL(a.href, location.origin).pathname.replace(/\/$/, '');
            if (loc === linkPath || (linkPath !== '' && loc.startsWith(linkPath + '/'))) {
                a.classList.add('active-link');
                a.setAttribute('aria-current', 'page');
            } else {
                a.classList.remove('active-link');
                a.removeAttribute('aria-current');
            }
        });
    }
    highlightNav();
    window.addEventListener('popstate', highlightNav);
    (function(){ const _push = history.pushState; history.pushState = function(){ _push.apply(this, arguments); highlightNav(); }; })();

    const alertPlaceholder = document.getElementById('alertPlaceholder');
    const updateJRModalEl = document.getElementById('updateJRModal');
    const updateJRModal = new bootstrap.Modal(updateJRModalEl);

    function showAlert(msg, type='success'){
        const w = document.createElement('div');
        w.innerHTML = `<div class="alert alert-${type} alert-dismissible" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
        alertPlaceholder.append(w);
        setTimeout(()=>w.remove(), 4500);
    }

    async function loadJR(){
        try {
            const res = await fetch('/join_requests');
            if(!res.ok) throw new Error('Failed to load join requests');
            const list = await res.json();
            renderTable(list);
        } catch (e) {
            document.getElementById('jrTableBody').innerHTML = `<tr><td colspan="6" class="text-danger text-center">Failed to load join requests</td></tr>`;
            console.error(e);
        }
    }

    function renderTable(list){
        const tbody = document.getElementById('jrTableBody');
        tbody.innerHTML = '';
        if(!Array.isArray(list) || list.length === 0){
            tbody.innerHTML = `<tr><td colspan="6" class="text-center">No join requests found</td></tr>`;
            return;
        }
        list.forEach(jr => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${jr.requestId ?? ''}</td>
                <td>${jr.requesterId ?? ''}</td>
                <td>${jr.circleId ?? ''}</td>
                <td>${jr.approverId ?? ''}</td>
                <td>${jr.isApproved ? 'Yes' : 'No'}</td>
                <td>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" data-action="edit" data-id="${jr.requestId}">Edit</button>
                        <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${jr.requestId}">Delete</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });

        tbody.querySelectorAll('button[data-action="edit"]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
                const id = btn.getAttribute('data-id');
                try {
                    const res = await fetch(`/join_requests/${id}`);
                    if(!res.ok){
                        if(res.status===404){ showAlert('Not found','warning'); loadJR(); return; }
                        throw new Error('Failed to fetch');
                    }
                    const jr = await res.json();
                    document.getElementById('updateRequestId').value = jr.requestId;
                    document.getElementById('updateRequesterId').value = jr.requesterId ?? '';
                    document.getElementById('updateCircleId').value = jr.circleId ?? '';
                    document.getElementById('updateApproverId').value = jr.approverId ?? '';
                    document.getElementById('updateIsApproved').checked = !!jr.isApproved;
                    updateJRModal.show();
                } catch (e) {
                    console.error(e);
                    showAlert('Failed to load join request','danger');
                }
            });
        });

        tbody.querySelectorAll('button[data-action="delete"]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
                const id = btn.getAttribute('data-id');
                if(!confirm('Delete join request #' + id + '?')) return;
                try {
                    const res = await fetch(`/join_requests/${id}`, { method: 'DELETE' });
                    if(res.ok){ showAlert('Deleted'); loadJR(); }
                    else if(res.status===404){ showAlert('Not found','warning'); loadJR(); }
                    else throw new Error('Delete failed');
                } catch (e) {
                    console.error(e);
                    showAlert('Failed to delete','danger');
                }
            });
        });
    }

    // Create
    document.getElementById('createJRForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const payload = {
            requesterId: document.getElementById('createRequesterId').value ? Number(document.getElementById('createRequesterId').value) : null,
            circleId: document.getElementById('createCircleId').value ? Number(document.getElementById('createCircleId').value) : null,
            approverId: document.getElementById('createApproverId').value ? Number(document.getElementById('createApproverId').value) : null,
            isApproved: document.getElementById('createIsApproved').checked
        };
        try {
            const res = await fetch('/join_requests', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(payload)
            });
            if(res.ok){ const created = await res.json(); showAlert('Created (ID: ' + (created.requestId ?? '') + ')'); e.target.reset(); loadJR(); }
            else { const t = await res.text(); throw new Error(t || 'Create failed'); }
        } catch (e) {
            console.error(e);
            showAlert('Failed to create','danger');
        }
    });

    // Update
    document.getElementById('updateJRModalForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const id = document.getElementById('updateRequestId').value;
        const payload = {
            requesterId: document.getElementById('updateRequesterId').value ? Number(document.getElementById('updateRequesterId').value) : null,
            circleId: document.getElementById('updateCircleId').value ? Number(document.getElementById('updateCircleId').value) : null,
            approverId: document.getElementById('updateApproverId').value ? Number(document.getElementById('updateApproverId').value) : null,
            isApproved: document.getElementById('updateIsApproved').checked
        };
        try {
            const res = await fetch(`/join_requests/${id}`, {
                method: 'PUT',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(payload)
            });
            if(res.ok){ showAlert('Updated'); updateJRModal.hide(); loadJR(); }
            else if(res.status===404){ showAlert('Not found','warning'); loadJR(); }
            else { const t = await res.text(); throw new Error(t || 'Update failed'); }
        } catch (e) {
            console.error(e);
            showAlert('Failed to update','danger');
        }
    });

    // initial load
    loadJR();
</script>
</body>
</html>